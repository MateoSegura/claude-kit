{
  "hooks": {
    "SessionStart": [
      {
        "matcher": "compact",
        "hooks": [
          {
            "type": "agent",
            "prompt": "You are the context-recovery agent for the core-planner plugin. Your job is to restore working context after conversation history was compacted. Be precise and concise.\n\nRECOVERY PROCEDURE:\n\n1. Read docs/plans/.active to find the active plan directory. If missing, output \"No active plan found. Use /core-planner:plan to create one.\" and stop.\n\n2. FAST PATH — Read docs/plans/<active>/state.json. If it exists and contains valid JSON, extract:\n   - current_phase (integer)\n   - last_completed_task_id\n   - last_completed_phase\n   - timestamp\n   Use these values directly. Skip to step 4.\n\n3. FALLBACK — If state.json is missing or malformed:\n   a. Read docs/plans/<active>/.current-phase for the current phase number (single integer).\n   b. Read docs/plans/<active>/status.log (last 40 lines). Find the most recent COMPACTION_SNAPSHOT marker. Parse COMPLETED entries after it for progress context.\n   c. If .current-phase is also missing, infer current phase from the highest phase number in COMPLETED entries + 1.\n\n4. Read docs/plans/<active>/overview.md — extract the Context section (original request and conversation state), Goal, Architecture Decisions, Constraints, and Key Files.\n\n5. Read the current phase file: docs/plans/<active>/phases/phase-NN.md (zero-pad the phase number, e.g., phase-03.md).\n\n6. VERIFY: Read the phase file from step 5. Check for uncompleted steps (lines containing \"- [ ]\"). If ALL steps show \"- [x]\" (completed), increment the phase number and read the next phase file. If that file does not exist, check TaskList for in-progress or pending tasks. Report whichever phase has remaining work.\n\n7. Check TaskList for in-progress and pending tasks.\n\nOUTPUT FORMAT (keep under 500 words):\n**Project**: [one-line goal from overview.md]\n**Context**: [original request summary from Context section]\n**Current Phase**: [N — phase title]\n**Last Completed**: [most recent COMPLETED entry]\n**Next Steps**: [remaining uncompleted steps from current phase file]\n**Key Decisions**: [architecture decisions from overview.md that affect current work]\n**Active Tasks**: [in-progress TaskList items with IDs]",
            "model": "sonnet",
            "timeout": 45,
            "description": "Restore context after compaction by reading state.json snapshot and plan files (sonnet model for higher accuracy)"
          }
        ]
      },
      {
        "matcher": "startup|resume",
        "hooks": [
          {
            "type": "command",
            "command": "ACTIVE_DIR=\"\"; if [ -f docs/plans/.active ]; then ACTIVE_DIR=\"docs/plans/$(cat docs/plans/.active)\"; fi; if [ -n \"$ACTIVE_DIR\" ] && [ -f \"$ACTIVE_DIR/status.log\" ]; then echo \"[core-planner] Active plan: $(cat docs/plans/.active)\"; echo \"Recent activity:\"; tail -5 \"$ACTIVE_DIR/status.log\"; else echo \"[core-planner] No active plan. Use /core-planner:plan to create one.\"; fi",
            "description": "Show recent plan activity on session start/resume"
          }
        ]
      }
    ],
    "PreToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/verify-plan.sh",
            "description": "Block source file edits without an active plan"
          }
        ]
      }
    ],
    "PostToolUse": [
      {
        "matcher": "Write|Edit",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/check-plan-integrity.sh",
            "description": "Validate plan file structure after writes (overview.md sections, phase file sections, status.log guard)"
          },
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/check-phase-drift.sh",
            "description": "Advisory drift detection: warn when edit falls outside current phase scope"
          }
        ]
      }
    ],
    "TaskCompleted": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/update-status.sh",
            "description": "Append task completion to active plan's status.log"
          }
        ]
      }
    ],
    "PreCompact": [
      {
        "matcher": "auto|manual",
        "hooks": [
          {
            "type": "command",
            "command": "${CLAUDE_PLUGIN_ROOT}/scripts/pre-compact-snapshot.sh",
            "description": "Write compaction boundary marker to status.log"
          }
        ]
      }
    ],
    "Stop": [
      {
        "matcher": "",
        "hooks": [
          {
            "type": "agent",
            "prompt": "Before allowing the session to end, verify plan consistency.\n\n1. Read docs/plans/.active to find the active plan directory. If missing, respond: {\"ok\": true} — no plan means nothing to verify.\n2. Read docs/plans/<active>/status.log — check for recent activity\n3. Check TaskList — are there in-progress tasks that weren't completed?\n4. Read the current phase file (identify from status.log) — are there steps marked as started but not finished?\n\nIf ALL of these are true, respond: {\"ok\": true}\n- No in-progress tasks left hanging (all either completed or still pending)\n- No obvious inconsistencies between status.log and TaskList\n\nIf ANY issue is found, respond:\n{\"ok\": false, \"reason\": \"[describe the inconsistency — e.g., 'Task #3 is marked in_progress but has no completion entry in status.log']\"}\n\nBe strict about in-progress tasks. It's better to warn about an abandoned task than to let the session end silently.",
            "model": "haiku",
            "timeout": 30,
            "description": "Check plan consistency before session end"
          }
        ]
      }
    ]
  }
}
