# Cross-Platform Architecture (Claude Code + Codex CLI)

## Design Principle

Write instructions and scripts once in a shared directory. Generate platform-specific configs for each tool. Shell scripts and MCP servers are 100% reusable. The main friction is hooks (Claude has 14 events; Codex has 1).

## Shared Directory Structure

```
monorepo/
├── .shared/                          # Cross-platform abstraction layer
│   ├── instructions/
│   │   ├── root.md                   # Shared instructions (source of truth)
│   │   ├── frontend.md               # Domain: frontend
│   │   ├── firmware.md               # Domain: firmware
│   │   └── backend.md                # Domain: backend
│   ├── skills/
│   │   ├── plan/
│   │   │   ├── plan.shared.md        # Platform-agnostic skill logic
│   │   │   └── scripts/
│   │   │       └── create-plan.sh    # Shared shell scripts
│   │   ├── implement/
│   │   │   └── implement.shared.md
│   │   └── review/
│   │       └── review.shared.md
│   ├── hooks/
│   │   ├── detect-domain.sh          # Works for both (reads file paths)
│   │   ├── update-status.sh          # Works for both (appends to log)
│   │   └── verify-plan.sh            # Checks file exists before impl
│   └── sync.sh                       # Generates platform-specific configs
│
├── # ── CLAUDE CODE (generated by sync.sh) ──
├── CLAUDE.md
├── .claude/
│   ├── settings.json
│   ├── rules/
│   │   └── standards.md
│   └── commands/
│       └── plan.md
│
├── # ── CODEX CLI (generated by sync.sh) ──
├── AGENTS.md
├── .codex/
│   └── config.toml
├── .agents/
│   └── skills/
│       └── plan/
│           └── SKILL.md
│
├── # ── SHARED STATE (both platforms use) ──
├── plan/
│   ├── overview.md
│   ├── status.log
│   └── phases/
│
└── src/
```

## Cross-Compatibility Assessment

### Easy (Trivial Effort)

| Thing | Notes |
|---|---|
| Instructions (CLAUDE.md / AGENTS.md) | Same markdown, different filenames |
| Skills | Same markdown + scripts, different directory layout |
| MCP servers | Same servers, JSON vs TOML config format |
| Shell scripts (hooks, tools) | Identical, both run bash |
| Plan files / status tracking | Both read/write same files |
| Non-interactive mode | `claude -p` vs `codex exec`, trivially aliased |

### Painful (Significant Friction)

| Thing | Problem |
|---|---|
| **Hooks** | Claude: 14 events, can block. Codex: 1 notification event, can't block. No equivalent for PreToolUse, TaskCompleted, SessionStart(compact). |
| **Compaction recovery** | Claude: agent hook on SessionStart(compact). Codex: no compaction hook. Must rely on AGENTS.md instructions (probabilistic). |
| **Domain detection** | Claude: PostToolUse hook injects context. Codex: no mechanism (but AGENTS.md auto-chains in subdirs). |
| **Managed enforcement** | Claude: `allowManagedHooksOnly`. Codex: `requirements.toml` constrains sandbox/approval but can't enforce custom hooks. |
| **Task list** | Claude: built-in persistent TaskList. Codex: no equivalent. |

## The sync.sh Script

Generates platform-specific configs from shared sources:

1. Copies `.shared/instructions/root.md` to both `CLAUDE.md` and `AGENTS.md`
2. Generates `.claude/settings.json` with hooks referencing `.shared/hooks/` scripts
3. Generates `.codex/config.toml` with MCP and notification config
4. Copies shared skills to both `.claude/commands/` and `.agents/skills/`

## Workload Tiering Recommendation

```
CLAUDE CODE (primary - use for):
├── Long autonomous sessions (hook-driven recovery)
├── Multi-domain work (domain detection hooks)
├── Security-sensitive work (PreToolUse blocking)
├── Complex planning (supervisor/worker via Task tool)
└── Anything needing deterministic enforcement

CODEX CLI (secondary - use for):
├── Cloud-delegated background tasks (codex cloud exec)
├── Quick one-shot tasks (codex exec)
├── CI/CD integration (open source, easier to embed)
├── Output schema enforcement (--output-schema)
└── Comparison benchmarks against Claude
```

## Note on Hooks Gap

Don't try to build a "universal hook layer" - it's a leaky abstraction. Instead:
- On Claude: deterministic hooks enforce the workflow
- On Codex: AGENTS.md instructions carry the same intent probabilistically
- Compare the results to determine which platform is more reliable per use case
