#!/bin/bash
set -euo pipefail

# Resolve INSTALL_DIR even when invoked via symlink
_SOURCE="${BASH_SOURCE[0]}"
while [ -L "$_SOURCE" ]; do
  _DIR="$(cd "$(dirname "$_SOURCE")" && pwd)"
  _SOURCE="$(readlink "$_SOURCE")"
  [[ "$_SOURCE" != /* ]] && _SOURCE="$_DIR/$_SOURCE"
done
INSTALL_DIR="$(cd "$(dirname "$_SOURCE")" && pwd)"

PLUGINS_DIR="$INSTALL_DIR/plugins"
CONFIG_FILE="$INSTALL_DIR/config.json"

KNOWN_TYPES="coding system"

# Resolve an alias from config.json. Prints plugin names (one per line) on success.
resolve_alias() {
  local name="$1"
  if [[ -f "$CONFIG_FILE" ]] && command -v jq &>/dev/null; then
    local plugins
    plugins=$(jq -r --arg n "$name" '.aliases[$n].plugins // empty | .[]' "$CONFIG_FILE" 2>/dev/null)
    if [[ -n "$plugins" ]]; then
      echo "$plugins"
      return 0
    fi
  fi
  return 1
}

# Resolve a prefix to all matching plugin directories. Prints plugin names (one per line).
resolve_prefix() {
  local prefix="$1"
  local found=false
  for d in "$PLUGINS_DIR/$prefix"-*/; do
    if [[ -d "$d" ]]; then
      found=true
      basename "$d"
    fi
  done
  $found
}

# Read companions from a plugin's ctl.json. Prints companion names (one per line).
resolve_companions() {
  local plugin_dir="$1"
  local ctljson="$plugin_dir/.claude-plugin/ctl.json"
  if [[ -f "$ctljson" ]] && command -v jq &>/dev/null; then
    jq -r '.companions // empty | .[]' "$ctljson" 2>/dev/null
  fi
}

validate_agent_name() {
  local name="$1"

  if resolve_alias "$name" &>/dev/null || resolve_prefix "$name" &>/dev/null; then
    return 0
  fi

  if [[ ! "$name" =~ ^[a-z]+-[a-z][-a-z]*$ ]]; then
    echo "Error: Name '$name' does not match required format: <type>-<domain>"
    echo "  - Must be all lowercase, hyphen-separated, two or more segments"
    echo "Examples: coding-cloud-go, coding-frontend-react, system-maker"
    exit 1
  fi

  local agent_type="${name%%-*}"
  local type_known=false
  for t in $KNOWN_TYPES; do
    if [[ "$agent_type" == "$t" ]]; then
      type_known=true
      break
    fi
  done

  if [[ "$type_known" == "false" ]]; then
    echo "Warning: Type '$agent_type' is not in the known list: $KNOWN_TYPES"
    echo "  The plugin will still run."
  fi
}

cmd_run() {
  local skip_permissions=false
  local agent_name=""

  while [[ $# -gt 0 ]]; do
    case "$1" in
      --yolo|-y)
        skip_permissions=true
        shift
        ;;
      -*)
        echo "Unknown flag: $1"
        echo "Usage: forge run [--yolo|-y] <name>"
        exit 1
        ;;
      *)
        agent_name="$1"
        shift
        ;;
    esac
  done

  if [ -z "$agent_name" ]; then
    echo "Usage: forge run [--yolo|-y] <name>"
    exit 1
  fi

  validate_agent_name "$agent_name"

  local -a plugin_names=()
  local resolved_plugins
  if resolved_plugins=$(resolve_alias "$agent_name"); then
    while IFS= read -r p; do
      [[ -n "$p" ]] && plugin_names+=("$p")
    done <<< "$resolved_plugins"
  elif resolved_plugins=$(resolve_prefix "$agent_name"); then
    while IFS= read -r p; do
      [[ -n "$p" ]] && plugin_names+=("$p")
    done <<< "$resolved_plugins"
  else
    plugin_names=("$agent_name")
  fi

  local -a all_plugins=()
  for pname in "${plugin_names[@]}"; do
    local pdir="$PLUGINS_DIR/$pname"

    if [ ! -d "$pdir" ]; then
      echo "Plugin '$pname' not found in $PLUGINS_DIR/"
      echo ""
      cmd_list
      exit 1
    fi

    local companions
    companions=$(resolve_companions "$pdir")
    if [[ -n "$companions" ]]; then
      while IFS= read -r comp; do
        if [[ -n "$comp" ]]; then
          local comp_dir="$PLUGINS_DIR/$comp"
          if [ ! -d "$comp_dir" ]; then
            echo "Warning: Companion '$comp' (required by '$pname') not found in $PLUGINS_DIR/"
          else
            local already=false
            for existing in "${all_plugins[@]+"${all_plugins[@]}"}"; do
              [[ "$existing" == "$comp" ]] && already=true && break
            done
            [[ "$already" == "false" ]] && all_plugins+=("$comp")
          fi
        fi
      done <<< "$companions"
    fi

    local already=false
    for existing in "${all_plugins[@]+"${all_plugins[@]}"}"; do
      [[ "$existing" == "$pname" ]] && already=true && break
    done
    [[ "$already" == "false" ]] && all_plugins+=("$pname")
  done

  export CLAUDE_CODE_EXPERIMENTAL_AGENT_TEAMS=1

  local -a claude_args=()
  local -a plugin_dirs=()
  for p in "${all_plugins[@]}"; do
    plugin_dirs+=("$PLUGINS_DIR/$p")
  done
  if [[ ${#plugin_dirs[@]} -gt 0 ]]; then
    claude_args+=(--plugin-dir "${plugin_dirs[@]}")
  fi
  claude_args+=(--model opus)

  if [ "$skip_permissions" = true ]; then
    claude_args+=(--dangerously-skip-permissions)
    echo "Warning: Running with --dangerously-skip-permissions"
  fi

  if [[ ${#all_plugins[@]} -gt 1 ]]; then
    echo "Loading: ${all_plugins[*]}"
  fi

  # Launch from the user's current directory (not INSTALL_DIR).
  # This lets the user's project CLAUDE.md load naturally.
  exec claude "${claude_args[@]}"
}

cmd_list() {
  echo "Available plugins:"
  if [ -d "$PLUGINS_DIR" ]; then
    ls -1 "$PLUGINS_DIR/" 2>/dev/null | while read -r name; do
      if [ -d "$PLUGINS_DIR/$name" ]; then
        echo "  $name"
      fi
    done
  else
    echo "  (none)"
  fi

  if [ -d "$PLUGINS_DIR" ]; then
    local -A seen_prefixes=()
    local -a team_lines=()
    for d in "$PLUGINS_DIR"/*/; do
      [[ ! -d "$d" ]] && continue
      local name
      name=$(basename "$d")
      local prefix="${name%-*}"
      if [[ -n "$prefix" && "$prefix" != "$name" && -z "${seen_prefixes[$prefix]+x}" ]]; then
        local count=0
        for _ in "$PLUGINS_DIR/$prefix"-*/; do count=$((count + 1)); done
        if [[ $count -ge 2 ]]; then
          local members
          members=$(for m in "$PLUGINS_DIR/$prefix"-*/; do printf "%s" "$(basename "$m"),"; done)
          members="${members%,}"
          team_lines+=("  $prefix → [$members]")
        fi
        seen_prefixes[$prefix]=1
      fi
    done
    if [[ ${#team_lines[@]} -gt 0 ]]; then
      echo ""
      echo "Domain shortcuts (loads full team):"
      printf '%s\n' "${team_lines[@]}"
    fi
  fi

  if [[ -f "$CONFIG_FILE" ]] && command -v jq &>/dev/null; then
    local aliases
    aliases=$(jq -r '.aliases // empty | keys[]' "$CONFIG_FILE" 2>/dev/null)
    if [[ -n "$aliases" ]]; then
      echo ""
      echo "Aliases:"
      while IFS= read -r alias_name; do
        local desc plugins_list
        desc=$(jq -r --arg n "$alias_name" '.aliases[$n].description // "no description"' "$CONFIG_FILE" 2>/dev/null)
        plugins_list=$(jq -r --arg n "$alias_name" '.aliases[$n].plugins | join(", ")' "$CONFIG_FILE" 2>/dev/null)
        echo "  $alias_name → [$plugins_list] ($desc)"
      done <<< "$aliases"
    fi
  fi
}

cmd_validate() {
  local agent_name="${1:?Usage: forge validate <name>}"
  validate_agent_name "$agent_name"

  local plugin_dir="$PLUGINS_DIR/$agent_name"
  local errors=0

  if [ ! -d "$plugin_dir" ]; then
    echo "Error: Plugin directory not found: $plugin_dir"
    exit 1
  fi

  echo "Validating: $agent_name"
  echo ""

  if [ -f "$plugin_dir/.claude-plugin/plugin.json" ]; then
    echo "  [OK] .claude-plugin/plugin.json exists"
    if command -v jq &>/dev/null; then
      if ! jq empty "$plugin_dir/.claude-plugin/plugin.json" 2>/dev/null; then
        echo "  [FAIL] plugin.json is not valid JSON"
        errors=$((errors + 1))
      fi
    fi
  else
    echo "  [FAIL] .claude-plugin/plugin.json MISSING (required)"
    errors=$((errors + 1))
  fi

  for dir in commands agents skills hooks; do
    if [ -d "$plugin_dir/$dir" ]; then
      local count
      count=$(find "$plugin_dir/$dir" -type f | wc -l)
      echo "  [OK] $dir/ ($count files)"
    else
      echo "  [--] $dir/ (optional)"
    fi
  done

  if [ -f "$plugin_dir/hooks/hooks.json" ]; then
    if command -v jq &>/dev/null; then
      if ! jq empty "$plugin_dir/hooks/hooks.json" 2>/dev/null; then
        echo "  [FAIL] hooks/hooks.json is not valid JSON"
        errors=$((errors + 1))
      else
        local has_event_keys
        has_event_keys=$(jq -r '.hooks | type' "$plugin_dir/hooks/hooks.json" 2>/dev/null)
        if [[ "$has_event_keys" == "object" ]]; then
          echo "  [OK] hooks/hooks.json uses event-based keys"
        elif [[ "$has_event_keys" == "array" ]]; then
          echo "  [WARN] hooks/hooks.json uses flat array — needs event-based keys"
          errors=$((errors + 1))
        fi
      fi
    fi
  fi

  local extra_files
  extra_files=$(find "$plugin_dir/.claude-plugin" -type f ! -name "plugin.json" ! -name "ctl.json" 2>/dev/null)
  if [ -n "$extra_files" ]; then
    echo "  [WARN] Unexpected files inside .claude-plugin/:"
    echo "$extra_files" | while read -r f; do echo "    $f"; done
    errors=$((errors + 1))
  fi

  local ctl_json="$plugin_dir/.claude-plugin/ctl.json"
  if command -v jq &>/dev/null && [ -f "$ctl_json" ]; then
    local companions
    companions=$(jq -r '.companions // empty | .[]' "$ctl_json" 2>/dev/null)
    if [[ -n "$companions" ]]; then
      while IFS= read -r comp; do
        if [[ -n "$comp" ]]; then
          if [ -d "$PLUGINS_DIR/$comp" ]; then
            echo "  [OK] companion '$comp' exists"
          else
            echo "  [FAIL] companion '$comp' NOT FOUND"
            errors=$((errors + 1))
          fi
        fi
      done <<< "$companions"
    fi
  fi

  echo ""
  if [ "$errors" -eq 0 ]; then
    echo "Validation passed."
  else
    echo "Validation completed with $errors issue(s)."
    exit 1
  fi
}

cmd_update() {
  echo "Updating forge..."
  git -C "$INSTALL_DIR" pull --ff-only
  local ver
  ver=$(git -C "$INSTALL_DIR" describe --tags --always 2>/dev/null || git -C "$INSTALL_DIR" rev-parse --short HEAD 2>/dev/null || echo "unknown")
  echo "forge updated → $ver"
}

case "${1:-help}" in
  run)
    shift
    cmd_run "$@"
    ;;
  list)
    cmd_list
    ;;
  validate)
    shift
    cmd_validate "$@"
    ;;
  update)
    cmd_update
    ;;
  help|--help|-h)
    echo "Usage: forge <command> [args]"
    echo ""
    echo "Commands:"
    echo "  run [--yolo] <name>   Launch Claude with the specified plugin(s)"
    echo "  list                  List available plugins and shortcuts"
    echo "  validate <name>       Validate plugin structure"
    echo "  update                Pull latest plugins from remote"
    echo ""
    echo "Flags:"
    echo "  --yolo, -y            Skip all permission prompts"
    echo ""
    echo "Domain shortcuts: 'coding-embedded-zephyr' loads all zephyr plugins"
    echo "Aliases: named bundles defined in config.json"
    echo "Companions: auto-loaded via .claude-plugin/ctl.json (e.g. engineer → knowledge)"
    ;;
  *)
    echo "Unknown command: $1"
    echo "Run 'forge help' for usage."
    exit 1
    ;;
esac
